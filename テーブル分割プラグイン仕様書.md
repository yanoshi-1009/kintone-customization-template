# テーブル分割プラグイン

## 背景

kintone ではサブテーブル内のデータはデータとして扱いにくい。
例）ルックアップできない。
例）関連レコードできない。

## コンセプト

誰に：kintone のサブテーブル内のデータをルックアップ、関連レコードのデータとして参照したい人に
なんと：「実現したい設計ができた」といってもらう。

## 仕様概要

アプリのサブテーブルに登録したデータを、1 行ごとに他のアプリのレコードとして登録する。

## 基本設計

### 全体仕様

- 転記元のアプリを src アプリ、転記先のアプリを dist アプリとする。
- 転記できるサブテーブルは一つとする。（今後改善予定。）
- カスタマイズはプラグインとして実装する。
- 転記する項目は dist アプリのサブテーブルに存在し、かつ src アプリにも存在するフィールドとし、
  判定はフィールドコードで行う。
- dist アプリのサブテーブル以外の項目を src アプリに転記する際には標準機能のルックアップを利用する。
- src レコードのレコード番号は、dist アプリに転記必須とする。
  - 設定は設定画面仕様にて記載する。
- モバイルは未対応（今後改善予定。）

### プラグイン設定画面仕様

- デザインは kintone 標準のものをベースとする。
  - パーツは kintone UI Components を利用し実装する。
- 以下の設定を可能とする。
  - プラグインの有効 / 無効
  - dist アプリの ID 選択（数値フィールド）
  - dist アプリのレコード番号転記フィールド
    - フィールド種別|ドロップダウン
    - 選択肢｜ dist アプリのルックアップフィールド
    - 初期値｜なし
  - 転記対象の更新
    - 更新用のボタンを設置する。
    - ボタン押下時に src アプリと dist アプリのフィールド情報を取得、比較し対象のフィールドを決定する。
    - 決定したフィールドの項目一覧を設定画面に表示する。
  - 同期ボタンの設置（今後）
    - フィールド種別｜ラジオボタン
    - 選択肢｜有り / 無し
    - 初期値｜無し
    - 動作｜有りに設定した場合、各レコードの詳細画面に手動同期ボタンを表示する。
      （手動同期ボタンが押された場合、そのタイミングでのレコード情報を元に dist アプリに再動同期する。（CSV や REST API によるデータ登録の救済措置）

### プラグイン動作

- 設定画面で表示されている転記対象のフィールドを元に、src アプリから dist アプリへの転記を行う。
- src アプリのレコード登録、更新、削除に対応し、対象フィールドについては src アプリと dist アプリの情報がリアルタイムに同期されている状態とする。

## 詳細設計

### プラグイン動作

- レコード登録時
  - src アプリのサブテーブルのデータを 1 行 1 レコードとして dist アプリに追加する。
- dist アプリ登録時のレスポンスを元に、src アプリのサブテーブルの各行に dist アプリの当該レコード番号を保存する。
- レコード変更時
  - レコード編集画面に入ったときのレコードデータを取得（以下 A とする）し、編集終了時(app.record.edit.submit.success)に再度レコードデータを取得（以下 B とする）。A と B を比較し、サブテーブル行の追加や dist アプリに転記している項目に変更があった際に以下の処理を実施する。なお、dist アプリの処理にはサブテーブルに保存している dist アプリの各レコード番号を利用する。
  - サブテーブル内の項目に変更があった場合
    - dist アプリの当該レコードを変更する。
  - サブテーブルの行が追加された場合
    - 追加された行を dist アプリのレコードとして追加する。
  - サブテーブルの行が削除された場合
    - dist アプリの当該レコードを削除する。
  - アプリに転記している項目（案件名等）に変更があった場合
    - 当該 src アプリレコードに紐づく dist アプリの対象レコードで再ルックアップ処理を行う。
- レコード削除時
  - dist アプリの当該 src アプリレコードに紐づくすべてのレコードを削除する。

## 注意点

- dist アプリ側での変更による、src アプリ側との不整合を防ぐため、dist アプリのレコード操作（追加、編集、削除）権限を制御する。
- データは 2 重持ちになるため、検索での可用性が低下する。

## 制限事項

- モバイル非対応
- 既に作成、運用中のアプリには対応しない
  - src アプリの既存レコードに対して dist アプリにデータを作成する処理は実装しない
- csv や REST API による src アプリへのレコード登録へは対応しない
